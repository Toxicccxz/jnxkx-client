<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin 
	name="hp_status_bars"
	author="醉轻侯" id="66c7d927ed3516f8cfadc2ec"
	language="Lua" purpose="江南侠客行HP状态栏"
	save_state="y" date_written="2016-08-18 00:22:37"
	requires="4.94"
	version="1.0">
    <description trim="y">
        江南侠客行HP状态栏
    </description>
</plugin>


<!--  Get our standard constants -->
<include name="constants.lua"/>

<!--  Script  -->
<script>
<![CDATA[
require "movewindow"
require "gauge"

---------------------------------------------------------------------------------
-- 函数定义 开始

--- - 描述: 自定义AddTrigger函数，同时会加入组
function Fun_AddTrigger(name, match, group, script)
    local value = AddTrigger(name, match, "", trigger_flag.KeepEvaluating + trigger_flag.RegularExpression + trigger_flag.Replace + trigger_flag.Temporary, custom_colour.NoChange, 0, "", script)
    SetTriggerOption(name, "group", group)

    if value ~= 0 then
        ColourNote("red", "black", name .. " Fun_AddTrigger false")
    end

    return value
end

--- - 描述: 设置触发器行数
function Fun_SetTriggerLine(name, line)
    local value = SetTriggerOption(name, "multi_line", "y")
    if value ~= 0 then
        ColourNote("red", "black", name .. " Fun_SetTriggerLine false")
    end
    value = SetTriggerOption(name, "lines_to_match", line)
    if value ~= 0 then
        ColourNote("red", "black", name .. " Fun_SetTriggerLine false")
    end
end

---- Called as the window is dragged around. This function and those below are
function ResizeMoveCallback()
   --[[ posx, posy = WindowInfo(win, 17), WindowInfo (win, 18)
   width = width + posx - startx
   startx = posx
   if (width < MIN_WIDTH) then
      width = MIN_WIDTH
      startx = windowinfo.window_left+width
   elseif (windowinfo.window_left+width > GetInfo(281)) then
      width = GetInfo(281)-windowinfo.window_left
      startx = GetInfo(281)
   end 

   if (utils.timer() - lastRefresh > 0.0333) then
      SetUpHotspotsAndDraw(false)
      lastRefresh = utils.timer()
   end
   ]]--
end

lastRefresh = 0

---- Called after the resize widget is released.
function ResizeReleaseCallback()
   --SetUpHotspotsAndDraw(false)
end

--- - 绘制窗口
function DrawStatusBar(params)
    params.effectiveWidth = math.max(params.min_width, math.min(params.width, GetInfo(281) - params.windowinfo.window_left))
    if params.first_time then
        check(WindowCreate(params.pluginId,
            params.windowinfo.window_left, params.windowinfo.window_top, -- left, top (auto-positions)
            params.effectiveWidth, -- width
            params.height, -- height
            params.windowinfo.window_mode, -- auto-position: middle right
            params.windowinfo.window_flags, -- flags
            params.background_colour))
        -- Add handler for resizing
        WindowAddHotspot(
            params.pluginId, "resize", 
            params.effectiveWidth-params.resize_tag_size, 
            params.height-params.resize_tag_size, 
            params.effectiveWidth, 
            params.height, 
            "MouseOver", "CancelMouseOver", "MouseDown", "CancelMouseDown", "MouseUp", "", 6, 0)
        WindowDragHandler(params.pluginId, "resize", "ResizeMoveCallback", "ResizeReleaseCallback", 0)
        CallPlugin("462b665ecb569efbf261422f", "registerMiniwindow", params.pluginId)
        WindowShow(params.pluginId, true)
    else
        -- everything has already been made
        -- just move them back into place
        WindowResize(params.pluginId, params.effectiveWidth, params.height, params.background_colour)
        --WindowMoveHotspot(winParams.pluginId, "resize", effectiveWidth-RESIZE_TAG_SIZE, height-RESIZE_TAG_SIZE, effectiveWidth, height)
    end

    -- Add the drag handler so they can move the window around
    movewindow.add_drag_handler(params.pluginId, 0, 0, 0, 0)

    DisplayStatsInfo(params)
end

-- 展示HP中状态信息
function DisplayStatsInfo(params)
    WindowRectOp(params.pluginId, 2, 2, 2, -2, -2, params.background_colour)
   
   -- 绘制窗口边框.
   WindowRectOp (params.pluginId, 1, 0, 0, 0, 0, params.border_color, 15)
   WindowRectOp (params.pluginId, 1, 1, 1, -1, -1, 0x777777, 15)

   -- 绘制调整大小的按钮
   WindowLine(params.pluginId, params.effectiveWidth-3, params.height-2, params.effectiveWidth-2, params.height-3, 0xffffff, 0, 2)
   WindowLine(params.pluginId, params.effectiveWidth-4, params.height-2, params.effectiveWidth-2, params.height-4, 0x696969, 0, 1)
   WindowLine(params.pluginId, params.effectiveWidth-6, params.height-2, params.effectiveWidth-2, params.height-6, 0xffffff, 0, 2)
   WindowLine(params.pluginId, params.effectiveWidth-7, params.height-2, params.effectiveWidth-2, params.height-7, 0x696969, 0, 1)
   WindowLine(params.pluginId, params.effectiveWidth-9, params.height-2, params.effectiveWidth-2, params.height-9, 0xffffff, 0, 2)
   WindowLine(params.pluginId, params.effectiveWidth-10, params.height-2, params.effectiveWidth-2, params.height-10, 0x696969, 0, 1)
   WindowLine(params.pluginId, params.effectiveWidth-12, params.height-2, params.effectiveWidth-2, params.height-12, 0xffffff, 0, 2)
   WindowLine(params.pluginId, params.effectiveWidth-13, params.height-2, params.effectiveWidth-2, params.height-13, 0x696969, 0, 1)
end

-- 函数定义 结束
---------------------------------------------------------------------------------

---------------------------------------------------------------------------------
-- 程序初始化 开始

-- 窗口默认参数
local winParams = {
    first_time = true,
    background_colour = 0x000000,
    border_color = 0xcccccc,
    width = 1137,
    height = 0,
    x = 0,
    y = 552,
    resize_tag_size = 10,
    min_width = 40,
    left_margin = 10,
    top_margin = 5,
    font_id = "f1",
    font_name = "Arial",
    font_size = "8",
    windowinfo = null,
    pluginId,
}

-- 状态默认数据
local status = {
    exp = { name = "经验:", val = 0, 0x0000ff, 0x00ffff },
    pot = { name = "潜能:", val = 0, 0x0000ff, 0x00ffff },
    neili = { name = "内力:", val = 0, curr_max = 0, 0x0000ff, 0x00ffff },
    jingli = { name = "精力:", val = 0, curr_max = 0, 0x0000ff, 0x00ffff },
    qi = { name = "气血:", val = 0, curr_max = 0, max = 0, 0x00ff00, 0x004400 },
    jing = { name = "精神:", val = 0, curr_max = 0, max = 0, 0xff5500, 0x442200 },
    food = { name = "食物:", val = 0, max = 0, 0x00ffff, 0x004444 },
    water = { name = "饮水:", val = 0, max = 0, 0xffffff, 0x444444 }
}

-- 获得当前插件的唯一ID（24字符）
winParams.pluginId = GetPluginID()


--[[ 触发器列表
local triggerList = {
    {
        -- hpbrief命令
        funame = "brief",
        funtrigger = "^[> ]*#(.+),(.+),(\\d+),(\\d+),(\\d+),(\\d+)\\n#(\\d+),(\\d+),(\\d+),(\\d+),(\\d+),(\\d+)",
        line = 2,
    },
    {
        -- 自己受击
        funame = "selfbehit",
        funtrigger = "^[> ]*[(] 你.+『(\\S+)[(]damage.*气血: (.+)[%][/](.+)[%][)]』",
    },
    {
        -- 受击
        funame = "behit",
        funtrigger = "『(\\S+)[(]damage.*气血: (.+)[%][/](.+)[%][)]』",
    }
}

-- 生成触发器
for i = 1, #triggerList do
    Fun_AddTrigger("trigger_hp_" .. triggerList[i].funame, triggerList[i].funtrigger, "hp_status", "hp_" .. triggerList[i].funame)
    if triggerList[i].line ~= nil and triggerList[i].line > 1 then
        Fun_SetTriggerLine("trigger_hp_" .. triggerList[i].funame, triggerList[i].line)
    end
end
]] --


-- 程序初始化 结束
---------------------------------------------------------------------------------

---------------------------------------------------------------------------------
-- 插件需要响应的事件 开始

---- 插件第一次安装
function OnPluginInstall()
    -- 创建窗口
    WindowCreate(winParams.pluginId, 600, 600, 1, 1, 0, 0, winParams.background_colour)

    -- 设置窗体字体
    WindowFont(winParams.pluginId, winParams.font_id, winParams.font_name, winParams.font_size, false, false, false, false)
    -- 设置窗体拖动处理器
    winParams.windowinfo = movewindow.install(
        winParams.pluginId, 
        miniwin.pos_top_right, 
        miniwin.create_absolute_location, 
        false, 
        nil, 
        { mouseup = MouseUp, mousedown = LeftClickOnly, dragmove = LeftClickOnly, dragrelease = LeftClickOnly }, 
        { x = winParams.x, y = winParams.y }
        )

    -- 统计需要展示的属性文本和数量
    local barTexts = ""
    local numBars = 0
    for i, v in pairs(status) do
        barTexts = barTexts .. v.name
        numBars = numBars + 1
    end

    local font_height = WindowFontInfo(winParams.pluginId, winParams.font_id, 1) - WindowFontInfo(winParams.pluginId, winParams.font_id, 4) + 1
    local font_width = WindowFontInfo(winParams.pluginId, winParams.font_id, 6)
    local line_height = font_height + 1

    -- 根据显示的数据长度，设定窗口宽度
    local curr_width = math.max(40, WindowTextWidth(winParams.pluginId, winParams.font_id, barTexts) + (winParams.left_margin * (numBars + 2)))
    winParams.height = (winParams.top_margin * 2 + line_height)*2
    winParams.width = math.max(winParams.width, winParams.min_width)

    -- 绘制窗口
    DrawStatusBar(winParams);
end

---- 保存窗口状态
function OnPluginSaveState ()
    movewindow.save_state (winParams.pluginId)
end

---- 插件启用
function OnPluginEnable ()
   WindowShow (winParams.pluginId, true)
   OnPluginSaveState()
end

---- 插件禁用
function OnPluginDisable ()
   OnPluginSaveState()
   WindowShow(winParams.pluginId, false )
end

-- 插件需要响应的事件 结束
---------------------------------------------------------------------------------
]]>
</script>


</muclient>
